# 交易终端使用指南

## 概述

`trading_terminal.py` 是一个基于 Rich 库开发的实时交易终端界面，提供美观的命令行交易体验。它连接到 MCP 服务器，实时显示账户信息、持仓情况和订单状态，并支持交互式交易操作。

## 功能特性

- 🎯 **实时界面**: 每3秒自动刷新账户和持仓数据
- 📊 **账户概览**: 显示现金、持仓市值、总资产等信息
- 📈 **持仓详情**: 展示每只股票的持仓量、成本价、盈亏情况
- 📋 **订单跟踪**: 显示每个股票的活跃订单状态
- 💬 **命令输入**: 支持买入、卖出、撤单等交易命令
- 🎨 **美观界面**: 使用 Rich 库提供彩色、格式化的终端显示

## 界面布局

```
┌─────────────────────────────────────────────────┐
│ 📊 账户信息                                       │
│ 账户ID: 8887181228                              │
│ 可用资金: ¥100,000.00                           │
│ 冻结资金: ¥0.00                                 │
│ 持仓市值: ¥150,000.00                           │
│ 总资产: ¥250,000.00                             │
│ 最后更新: 14:30:25                              │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 📈 持仓情况                                       │
│ ┌─────────────────────────────────────────────┐ │
│ │ 股票代码  持仓量   可用量   成本价   当前价  │ │
│ │ 000001   1000    1000    ¥10.50  ¥10.55 │ │
│ │   └─ 订单 123456: buy 100 @ ¥10.50 (已报) │ │
│ │ 600000   500     500     ¥8.20   ¥8.25   │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 💬 命令输入                                       │
│ 支持的命令:                                     │
│ • buy CODE VOLUME [PRICE]    - 买入委托        │
│ • sell CODE VOLUME [PRICE]   - 卖出委托        │
│ • cancel ORDER_ID            - 撤单            │
│ • refresh                    - 手动刷新数据      │
│ • quit                       - 退出程序          │
│                                                 │
│ 输入命令后按回车执行...                          │
│ 交易命令 > _                                    │
└─────────────────────────────────────────────────┘
```

## 安装依赖

```bash
pip install rich requests
```

## 启动方式

### 1. 确保 MCP 服务器已启动

首先启动 MCP 服务器并启用交易功能：

```bash
# 启动 MCP 服务器（带交易功能）
python mcp/run_server.py --enable-trade \
  --trader-path "G:\国金证券QMT交易端\userdata_mini" \
  --account-id "8887181228" \
  --api-key "your-secret-key"
```

### 2. 启动交易终端

```bash
# 基本启动
python monitor/trading_terminal.py

# 指定服务器地址
python monitor/trading_terminal.py --server-url "http://localhost:9696"

# 指定API密钥
python monitor/trading_terminal.py --api-key "your-secret-api-key"
```

### 3. 环境变量设置

也可以通过环境变量设置API密钥：

```bash
export XTDATA_MCP_API_KEY="your-secret-api-key"
python monitor/trading_terminal.py
```

## 命令说明

### 买入命令

```bash
# 限价买入
buy 000001 100 10.50

# 市价买入（不指定价格）
buy 000001 100
```

### 卖出命令

```bash
# 限价卖出
sell 000001 100 10.50

# 市价卖出（不指定价格）
sell 000001 100
```

### 撤单命令

```bash
# 根据订单ID撤单
cancel 123456
```

### 其他命令

```bash
# 手动刷新数据
refresh

# 退出程序
quit
```

## 数据显示说明

### 账户信息
- **账户ID**: 交易账户编号
- **可用资金**: 可用于交易的现金
- **冻结资金**: 被冻结的资金（委托中）
- **持仓市值**: 所有持仓股票的当前市值
- **总资产**: 现金 + 持仓市值
- **最后更新**: 数据最后更新时间

### 持仓信息
- **股票代码**: 6位股票代码
- **持仓量**: 总持仓数量
- **可用量**: 可用于卖出的数量
- **成本价**: 平均持仓成本
- **当前价**: 当前市场价格（需要实时数据源）
- **盈亏比**: 盈亏百分比
- **盈亏额**: 绝对盈亏金额

### 订单信息
每只股票下面会显示相关的活跃订单：
- **订单ID**: 系统分配的订单编号
- **类型**: buy（买入）或 sell（卖出）
- **数量**: 委托数量
- **价格**: 委托价格
- **状态**: 订单状态（已报、已成、已撤等）

**注意**: 已完成订单（已成、已撤、废单）超过120秒后会自动隐藏。

## 安全提醒

⚠️ **重要安全警告**

1. **真实交易**: 所有操作都会在真实账户上执行，涉及真实资金
2. **风险控制**: 请确保了解交易风险
3. **测试环境**: 建议先在模拟环境测试所有功能
4. **资金安全**: 确认账户有足够资金
5. **网络稳定**: 确保网络连接稳定
6. **API密钥**: 使用强API密钥保护接口安全

## 故障排除

### 连接问题
```
❌ 连接失败: 无法连接到服务器
```
**解决方案**:
- 检查 MCP 服务器是否已启动
- 确认服务器URL是否正确
- 检查防火墙和网络设置

### 交易功能不可用
```
⚠️ 未发现交易工具，可能交易功能未启用
```
**解决方案**:
- 确保使用 `--enable-trade` 参数启动服务器
- 检查服务器日志确认交易功能状态

### 权限问题
```
❌ 认证失败: 请检查API密钥设置
```
**解决方案**:
- 确认API密钥正确
- 检查API密钥格式（命令行或环境变量）

## 技术实现

- **界面库**: 使用 Rich 库实现美观的终端界面
- **实时更新**: 每3秒自动刷新数据
- **多线程**: 使用线程实现后台自动刷新
- **错误处理**: 完善的异常处理和用户提示
- **键盘中断**: 支持 Ctrl+C 优雅退出

## 快捷键

- **Ctrl+C**: 退出程序
- **Enter**: 执行输入的命令
- **自动刷新**: 每3秒自动更新数据

## 扩展功能

未来可以扩展的功能：
- 实时价格数据源集成
- 图表显示功能
- 交易策略自动化
- 多账户支持
- 历史数据回放